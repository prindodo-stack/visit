<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전라남도교육청창의융합교육원 - 행사 및 급식 관리</title>
    <!-- 라이브러리 로드 순서 최적화 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .chart-bar { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .no-meal-day { background: repeating-linear-gradient(45deg, #f1f5f9, #f1f5f9 10px, #e2e8f0 10px, #e2e8f0 20px); opacity: 0.6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- type="text/babel"이 있어야 브라우저가 JSX를 해석합니다 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                dashboard: <path d="M3 3h7v9H3zm11 0h7v5h-7zm0 9h7v9h-7zm-11 11h7v-7H3z"/>,
                plus: <path d="M12 5v14M5 12h14"/>,
                list: <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>,
                utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2a5 5 0 0 0-5 5v8c0 1.1.9 2 2 2h3c0 1.1.9 2 2 2v3"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                refresh: <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>,
                chevronLeft: <path d="M15 18l-6-6 6-6"/>,
                chevronRight: <path d="M9 18l6-6-6-6"/>,
                settings: <React.Fragment><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></React.Fragment>,
                calendarX: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="10" y1="14" x2="14" y2="18"/><line x1="14" y1="14" x2="10" y2="18"/></React.Fragment>,
                alert: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const SUPABASE_URL = 'https://zyuybhszykxuafzriksn.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3h3_2LRYgdyeXdoDO6XZMA_4jQrQTtV'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const WEEKDAYS = ["일", "월", "화", "수", "목", "금", "토"];

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [viewMode, setViewMode] = useState('week');
            const [viewDate, setViewDate] = useState(new Date());
            
            const [baseSettings, setBaseSettings] = useState(() => {
                const saved = localStorage.getItem('jucie_settings_v4');
                return saved ? JSON.parse(saved) : { 
                    maxCapacity: 220, 
                    baseMealCount: 45,
                    operatingDays: [false, true, true, true, true, true, false], 
                    excludedDates: [] 
                };
            });

            const [formData, setFormData] = useState({
                event_date: new Date().toISOString().split('T')[0],
                department: '기획부',
                event_name: '',
                total_participants: 0,
                meal_participants: 0
            });

            useEffect(() => {
                localStorage.setItem('jucie_settings_v4', JSON.stringify(baseSettings));
            }, [baseSettings]);

            const fetchEvents = async () => {
                setLoading(true);
                try {
                    const { data, error } = await supabaseClient
                        .from('events')
                        .select('*')
                        .order('event_date', { ascending: true });
                    if (error) throw error;
                    setEvents(data || []);
                } catch (error) {
                    console.error("데이터 로딩 실패:", error);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchEvents(); }, []);

            const navigateDate = (direction) => {
                const nextDate = new Date(viewDate);
                if (viewMode === 'day') nextDate.setDate(viewDate.getDate() + direction);
                else if (viewMode === 'week') nextDate.setDate(viewDate.getDate() + (direction * 7));
                else if (viewMode === 'month') nextDate.setMonth(viewDate.getMonth() + direction);
                setViewDate(nextDate);
            };

            const filteredData = useMemo(() => {
                const start = new Date(viewDate);
                const end = new Date(viewDate);
                if (viewMode === 'day') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
                else if (viewMode === 'week') { const d = start.getDay(); start.setDate(start.getDate() - d); end.setDate(start.getDate() + 6); }
                else if (viewMode === 'month') { start.setDate(1); end.setMonth(start.getMonth() + 1); end.setDate(0); }

                let rangeDays = [];
                const tempDate = new Date(start);
                while (tempDate <= end) {
                    const dateStr = tempDate.toISOString().split('T')[0];
                    const dayIdx = tempDate.getDay();
                    const isOperating = baseSettings.operatingDays[dayIdx] && !baseSettings.excludedDates.includes(dateStr);
                    const dayEvents = events.filter(e => e.event_date === dateStr);
                    const sumVisitors = dayEvents.reduce((s, e) => s + Number(e.total_participants || 0), 0);
                    const sumVisitorMeals = dayEvents.reduce((s, e) => s + Number(e.meal_participants || 0), 0);
                    const totalMeals = isOperating ? (Number(baseSettings.baseMealCount) + sumVisitorMeals) : 0;

                    rangeDays.push({ dateStr, dayLabel: WEEKDAYS[dayIdx], shortDate: `${tempDate.getMonth()+1}/${tempDate.getDate()}`, isOperating, total: sumVisitors, meals: totalMeals });
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                const opDays = rangeDays.filter(d => d.isOperating);
                const totalMealsInPeriod = rangeDays.reduce((sum, d) => sum + d.meals, 0);
                return { items: rangeDays, summary: { total: rangeDays.reduce((s, d) => s + d.total, 0), meals: totalMealsInPeriod, avgMeals: opDays.length > 0 ? totalMealsInPeriod / opDays.length : 0 }, periodLabel: viewMode === 'month' ? `${viewDate.getFullYear()}년 ${viewDate.getMonth()+1}월` : `${start.toLocaleDateString()} ~ ${end.toLocaleDateString()}` };
            }, [events, viewMode, viewDate, baseSettings]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const { error } = await supabaseClient.from('events').insert([formData]);
                    if (error) throw error;
                    setFormData({ event_date: new Date().toISOString().split('T')[0], department: '기획부', event_name: '', total_participants: 0, meal_participants: 0 });
                    await fetchEvents();
                    setActiveTab('list');
                } catch (error) { alert(error.message); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row text-slate-800">
                    <nav className="w-full md:w-72 bg-slate-900 text-white p-6 flex flex-col shrink-0 z-30">
                        <div className="mb-10 flex items-center space-x-3">
                            <div className="bg-blue-600 p-2 rounded-xl"><Icon name="utensils" size={24} /></div>
                            <div>
                                <h1 className="text-xl font-black leading-none">JNCIE CMS</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase mt-1">행사 및 급식 관리</p>
                            </div>
                        </div>
                        <div className="space-y-1 flex-1">
                            {[{ id: 'dashboard', icon: 'dashboard', label: '통계 대시보드' }, { id: 'list', icon: 'list', label: '행사 내역 조회' }, { id: 'add', icon: 'plus', label: '신규 행사 등록' }].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl transition-all ${activeTab === item.id ? 'bg-blue-600 shadow-xl' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <Icon name={item.icon} size={18} /> <span className="font-bold text-sm">{item.label}</span>
                                </button>
                            ))}
                        </div>
                        <div className="mt-6 p-5 bg-slate-800/40 rounded-2xl border border-slate-700/50 space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[9px] text-slate-500 font-bold block mb-1">식당 정원</label>
                                    <input type="number" value={baseSettings.maxCapacity} onChange={e => setBaseSettings({...baseSettings, maxCapacity: Number(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs text-blue-400 font-black outline-none" />
                                </div>
                                <div>
                                    <label className="text-[9px] text-slate-500 font-bold block mb-1">고정 인원</label>
                                    <input type="number" value={baseSettings.baseMealCount} onChange={e => setBaseSettings({...baseSettings, baseMealCount: Number(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs text-green-400 font-black outline-none" />
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 p-6 md:p-10 overflow-y-auto">
                        {activeTab === 'dashboard' && (
                            <div className="max-w-6xl mx-auto space-y-8 animate-fadeIn">
                                <div className="flex flex-col lg:flex-row justify-between gap-6">
                                    <div>
                                        <h2 className="text-3xl font-black text-slate-900">현황 모니터링</h2>
                                        <p className="text-slate-400 text-sm">{filteredData.periodLabel}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex bg-white p-1 rounded-2xl shadow-sm border">
                                            {['day', 'week', 'month'].map(mode => (
                                                <button key={mode} onClick={() => setViewMode(mode)} className={`px-4 py-2 rounded-xl text-xs font-bold ${viewMode === mode ? 'bg-slate-900 text-white' : 'text-slate-400'}`}>{mode === 'day' ? '일간' : mode === 'week' ? '주간' : '월간'}</button>
                                            ))}
                                        </div>
                                        <div className="flex items-center bg-white rounded-2xl shadow-sm border">
                                            <button onClick={() => navigateDate(-1)} className="p-2 border-r"><Icon name="chevronLeft" size={18}/></button>
                                            <button onClick={() => setViewDate(new Date())} className="px-4 text-[11px] font-black text-slate-500">TODAY</button>
                                            <button onClick={() => navigateDate(1)} className="p-2 border-l"><Icon name="chevronRight" size={18}/></button>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                                        <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">총 방문자 (행사 인원)</p>
                                        <div className="flex items-baseline space-x-1"><h3 className="text-5xl font-black">{filteredData.summary.total.toLocaleString()}</h3><span className="text-slate-400 font-bold">명</span></div>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                                        <p className="text-[11px] font-black text-green-500 uppercase tracking-widest mb-2">실제 급식 예상 인원</p>
                                        <div className="flex items-baseline space-x-1"><h3 className="text-5xl font-black text-green-600">{filteredData.summary.meals.toLocaleString()}</h3><span className="text-slate-400 font-bold">명</span></div>
                                    </div>
                                    <div className="bg-slate-900 p-8 rounded-[2rem] shadow-2xl text-white">
                                        <p className="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-2">정원 대비 부하율</p>
                                        <h3 className={`text-5xl font-black ${filteredData.summary.avgMeals > baseSettings.maxCapacity ? 'text-red-400' : 'text-blue-400'}`}>{Math.round(filteredData.summary.avgMeals / baseSettings.maxCapacity * 100) || 0}%</h3>
                                    </div>
                                </div>

                                <div className="bg-white p-8 md:p-12 rounded-[2.5rem] shadow-sm border">
                                    <h3 className="text-2xl font-black text-slate-900 mb-8">데일리 운영 추이 (방문객 vs 실제 식수)</h3>
                                    <div className="h-[300px] flex items-end justify-between space-x-2 md:space-x-4">
                                        {filteredData.items.map((item, i) => {
                                            const maxRef = Math.max(...filteredData.items.map(d => Math.max(d.total, d.meals, 1)), baseSettings.maxCapacity);
                                            const isOver = item.meals > baseSettings.maxCapacity;
                                            return (
                                                <div key={i} className="flex-1 flex flex-col items-center group h-full relative">
                                                    <div className={`flex-1 w-full flex flex-col justify-end items-center rounded-2xl transition-all p-1 ${!item.isOperating ? 'no-meal-day' : 'hover:bg-slate-50'}`}>
                                                        {item.isOperating ? (
                                                            <div className="w-full flex items-end justify-center space-x-1 h-full">
                                                                <div className="w-1/2 bg-blue-400/30 rounded-t-lg chart-bar" style={{ height: `${(item.total / maxRef) * 100}%` }}></div>
                                                                <div className={`w-1/2 rounded-t-lg chart-bar ${isOver ? 'bg-red-500' : 'bg-green-500'}`} style={{ height: `${(item.meals / maxRef) * 100}%` }}></div>
                                                            </div>
                                                        ) : (
                                                            <div className="h-full flex items-center justify-center text-slate-300 text-[10px] font-bold">휴무</div>
                                                        )}
                                                    </div>
                                                    <div className="mt-4 text-center">
                                                        <p className="text-[11px] font-black text-slate-500">{item.dayLabel}</p>
                                                        <p className="text-[9px] font-bold text-slate-300">{item.shortDate}</p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'list' && (
                            <div className="max-w-6xl mx-auto space-y-6 animate-fadeIn">
                                <h2 className="text-2xl font-black">행사 내역 조회</h2>
                                <div className="bg-white rounded-3xl border overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b"><tr><th className="p-5">날짜</th><th className="p-5">부서</th><th className="p-5">행사명</th><th className="p-5 text-center">식수인원</th><th className="p-5"></th></tr></thead>
                                        <tbody>
                                            {events.slice().reverse().map(e => (
                                                <tr key={e.id} className="border-b hover:bg-slate-50/50">
                                                    <td className="p-5 font-bold text-slate-500">{e.event_date}</td>
                                                    <td className="p-5"><span className="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-black">{e.department}</span></td>
                                                    <td className="p-5 font-bold">{e.event_name}</td>
                                                    <td className="p-5 text-center font-black text-green-600">{e.meal_participants}명</td>
                                                    <td className="p-5"><button onClick={async () => { if(confirm("삭제하시겠습니까?")) { await supabaseClient.from('events').delete().match({id:e.id}); fetchEvents(); } }} className="text-slate-300 hover:text-red-500"><Icon name="trash" size={18}/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'add' && (
                            <div className="max-w-xl mx-auto animate-fadeIn">
                                <h2 className="text-2xl font-black mb-8 text-center">신규 행사 등록</h2>
                                <form onSubmit={handleSubmit} className="bg-white p-10 rounded-[2.5rem] shadow-xl border space-y-6">
                                    <div><label className="text-xs font-black text-slate-400 mb-2 block uppercase">행사 일정</label><input type="date" required className="w-full p-4 bg-slate-50 rounded-2xl outline-none" value={formData.event_date} onChange={e => setFormData({...formData, event_date: e.target.value})} /></div>
                                    <div><label className="text-xs font-black text-slate-400 mb-2 block uppercase">행사 명칭</label><input type="text" required placeholder="행사명을 입력하세요" className="w-full p-4 bg-slate-50 rounded-2xl outline-none" value={formData.event_name} onChange={e => setFormData({...formData, event_name: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-black text-slate-400 mb-2 block uppercase">총 참석자</label><input type="number" className="w-full p-4 bg-slate-50 rounded-2xl outline-none" value={formData.total_participants} onChange={e => setFormData({...formData, total_participants: e.target.value})} /></div>
                                        <div><label className="text-xs font-black text-green-500 mb-2 block uppercase">식수 인원</label><input type="number" className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-green-600" value={formData.meal_participants} onChange={e => setFormData({...formData, meal_participants: e.target.value})} /></div>
                                    </div>
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg shadow-xl hover:bg-black transition-all">등록하기</button>
                                </form>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
