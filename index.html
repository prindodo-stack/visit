<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>들락날락 - 창의융합교육원 급식관리</title>
    <!-- 라이브러리 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .custom-shadow { box-shadow: 0 4px 15px -3px rgba(28, 7, 112, 0.05); }
        .off-day-pattern { background: repeating-linear-gradient(45deg, #f8fafc, #f8fafc 10px, #f1f5f9 10px, #f1f5f9 20px); }
        .sidebar-active { background-color: #261CC1; color: white; box-shadow: 0 8px 15px -3px rgba(38, 28, 193, 0.3); }
        input[type="date"], input[type="number"], select { outline: none; transition: all 0.2s; }
        input[type="date"]:focus, input[type="number"]:focus, select:focus { ring: 2px; ring-color: #3A9AFF; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(15%) sepia(95%) saturate(3935%) hue-rotate(244deg) brightness(85%) contrast(105%); }
        
        /* 스크롤바 최적화 */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .content-area { height: calc(100vh - 80px); }
        @media (max-width: 768px) {
            .content-area { height: auto; overflow: visible; }
            body { overflow: auto; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        /**
         * 아이콘 컴포넌트: Lucide 아이콘을 브라우저 환경에서 안전하게 렌더링
         */
        const Icon = ({ name, size = 18, className = "", color = "currentColor", strokeWidth = 2.5 }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconElement.setAttribute('data-lucide', kebabName);
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    iconElement.style.display = 'inline-block';
                    if (color) iconElement.style.color = color;
                    
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({
                        icons: window.lucide.icons,
                        attrs: { 'stroke-width': strokeWidth, width: size, height: size },
                        elements: [iconElement]
                    });
                }
            }, [name, size, color, strokeWidth, className]);

            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`}></span>;
        };

        // --- 시스템 설정 ---
        const SUPABASE_URL = 'https://zyuybhszykxuafzriksn.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3h3_2LRYgdyeXdoDO6XZMA_4jQrQTtV'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const WEEKDAYS = ["일", "월", "화", "수", "목", "금", "토"];
        const ADMIN_PASSWORD = "1416";
        const COLORS = { deep: '#1C0770', royal: '#261CC1', sky: '#3A9AFF', lime: '#F1FF5E' };

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [events, setEvents] = useState([]);
            const [dailyOverrides, setDailyOverrides] = useState([]); // 일자별 개별 설정 상태
            const [loading, setLoading] = useState(false);
            const [viewMode, setViewMode] = useState('day');
            const [viewDate, setViewDate] = useState(new Date());
            
            const [notification, setNotification] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [pwInput, setPwInput] = useState("");

            // 전역 기본 설정
            const [baseSettings, setBaseSettings] = useState({ 
                maxCapacity: 220, 
                baseMealCount: 45,
                operatingDays: [false, true, true, true, true, true, false]
            });
            const [excludedDates, setExcludedDates] = useState([]);

            // 일자별 개별 설정 폼 상태
            const [specificOverride, setSpecificOverride] = useState({
                date: new Date().toISOString().split('T')[0],
                capacity: 220,
                baseCount: 45
            });

            // 기간/요일별 일괄 설정 폼 상태
            const [rangeOverride, setRangeOverride] = useState({
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                days: [false, false, false, false, false, false, false],
                capacity: 220,
                baseCount: 45
            });

            const [formData, setFormData] = useState({
                event_date: new Date().toISOString().split('T')[0],
                department: '기획부',
                event_name: '',
                total_participants: 0,
                meal_participants: 0
            });

            const fileInputRef = useRef(null);

            const safeLocaleString = (val) => (Number(val) || 0).toLocaleString();

            const showMsg = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const initData = async () => {
                setLoading(true);
                try {
                    // 1. 기본 설정 로드
                    const { data: sData } = await supabaseClient.from('site_settings').select('*').eq('id', 1).single();
                    if (sData) {
                        setBaseSettings({
                            maxCapacity: Number(sData.max_capacity || 220),
                            baseMealCount: Number(sData.base_meal_count || 45),
                            operatingDays: sData.operating_days || [false, true, true, true, true, true, false]
                        });
                    }
                    // 2. 휴무일 로드
                    const { data: eDates } = await supabaseClient.from('excluded_dates').select('date_str');
                    if (eDates) setExcludedDates(eDates.map(d => d.date_str));
                    
                    // 3. 일자별 개별 설정(Overrides) 로드
                    const { data: oData } = await supabaseClient.from('daily_overrides').select('*');
                    if (oData) setDailyOverrides(oData);

                    // 4. 행사 내역 로드
                    const { data: evData } = await supabaseClient.from('events').select('*').order('event_date', { ascending: true });
                    if (evData) setEvents(evData);
                } catch (err) { console.error(err); } finally { setLoading(false); }
            };

            useEffect(() => { initData(); }, []);

            const navigateDate = (direction) => {
                const nextDate = new Date(viewDate);
                if (viewMode === 'day') nextDate.setDate(viewDate.getDate() + direction);
                else if (viewMode === 'week') nextDate.setDate(viewDate.getDate() + (direction * 7));
                else if (viewMode === 'month') nextDate.setMonth(viewDate.getMonth() + direction);
                setViewDate(nextDate);
            };

            const filteredData = useMemo(() => {
                const start = new Date(viewDate);
                const end = new Date(viewDate);
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);

                if (viewMode === 'week') {
                    const day = start.getDay();
                    start.setDate(start.getDate() - day);
                    const lastDay = new Date(start);
                    lastDay.setDate(start.getDate() + 6);
                    end.setTime(lastDay.getTime());
                    end.setHours(23, 59, 59, 999);
                } else if (viewMode === 'month') {
                    start.setDate(1); end.setMonth(start.getMonth() + 1); end.setDate(0);
                    end.setHours(23, 59, 59, 999);
                }

                let rangeDays = [];
                const tempDate = new Date(start);
                while (tempDate <= end) {
                    const dateStr = tempDate.toISOString().split('T')[0];
                    const dayIdx = tempDate.getDay();
                    
                    // 1. 해당 일자의 개별 설정값 확인
                    const override = dailyOverrides.find(o => o.date_str === dateStr);
                    const currentCapacity = override ? Number(override.capacity) : Number(baseSettings.maxCapacity);
                    const currentBaseMeal = override ? Number(override.base_meal_count) : Number(baseSettings.baseMealCount);

                    const isOperating = baseSettings.operatingDays[dayIdx] && !excludedDates.includes(dateStr);
                    const dayEvents = events.filter(e => e.event_date === dateStr);
                    const sumTotal = dayEvents.reduce((s, e) => s + Number(e.total_participants || 0), 0);
                    const sumMeals = dayEvents.reduce((s, e) => s + Number(e.meal_participants || 0), 0);
                    const totalMeals = isOperating ? (currentBaseMeal + sumMeals) : 0;
                    const remaining = isOperating ? (currentCapacity - totalMeals) : 0;

                    rangeDays.push({
                        dateStr, dayLabel: WEEKDAYS[dayIdx],
                        shortDate: `${tempDate.getMonth() + 1}/${tempDate.getDate()}`,
                        isOperating, total: sumTotal, meals: totalMeals, remaining, events: dayEvents,
                        capacity: currentCapacity, baseCount: currentBaseMeal, isOverridden: !!override
                    });
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                return {
                    items: rangeDays,
                    summary: { 
                        total: rangeDays.reduce((sum, d) => sum + d.total, 0), 
                        meals: rangeDays.reduce((sum, d) => sum + d.meals, 0) 
                    },
                    periodLabel: viewMode === 'month' ? `${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월` : 
                                 viewMode === 'day' ? `${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월 ${viewDate.getDate()}일` :
                                 `${start.toLocaleDateString('ko-KR', {month:'long', day:'numeric'})} ~ ${end.toLocaleDateString('ko-KR', {month:'long', day:'numeric'})}`
                };
            }, [events, viewMode, viewDate, baseSettings, excludedDates, dailyOverrides]);

            const saveSettings = async () => {
                setLoading(true);
                try {
                    const { error } = await supabaseClient.from('site_settings').update({
                        max_capacity: Number(baseSettings.maxCapacity),
                        base_meal_count: Number(baseSettings.baseMealCount),
                        operating_days: baseSettings.operating_days
                    }).eq('id', 1);
                    if (error) throw error;
                    showMsg("전역 설정 저장 완료", "success");
                } catch (err) { showMsg("저장 실패", "error"); } finally { setLoading(false); }
            };

            // 특정 일자 설정 저장
            const handleSaveSpecificOverride = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const { error } = await supabaseClient.from('daily_overrides').upsert([{
                        date_str: specificOverride.date,
                        capacity: Number(specificOverride.capacity),
                        base_meal_count: Number(specificOverride.baseCount)
                    }]);
                    if (error) throw error;
                    showMsg(`${specificOverride.date} 설정이 적용되었습니다.`, "success");
                    initData();
                } catch (err) { showMsg("오류 발생", "error"); } finally { setLoading(false); }
            };

            // 기간/요일별 일괄 설정 저장
            const handleSaveRangeOverride = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const start = new Date(rangeOverride.startDate);
                    const end = new Date(rangeOverride.endDate);
                    const batch = [];
                    const temp = new Date(start);

                    while (temp <= end) {
                        const dateStr = temp.toISOString().split('T')[0];
                        const dayIdx = temp.getDay();
                        if (rangeOverride.days[dayIdx]) {
                            batch.push({
                                date_str: dateStr,
                                capacity: Number(rangeOverride.capacity),
                                base_meal_count: Number(rangeOverride.baseCount)
                            });
                        }
                        temp.setDate(temp.getDate() + 1);
                    }

                    if (batch.length === 0) {
                        showMsg("선택된 기간 내 해당하는 요일이 없습니다.", "error");
                        setLoading(false);
                        return;
                    }

                    const { error } = await supabaseClient.from('daily_overrides').upsert(batch);
                    if (error) throw error;
                    showMsg(`${batch.length}개 일자의 설정이 일괄 적용되었습니다.`, "success");
                    initData();
                } catch (err) { showMsg("일괄 저장 실패", "error"); } finally { setLoading(false); }
            };

            const toggleExcludedDate = async (dateStr) => {
                if (!isAdmin) { showMsg("관리자 인증이 필요합니다.", "error"); return; }
                try {
                    if (excludedDates.includes(dateStr)) {
                        await supabaseClient.from('excluded_dates').delete().eq('date_str', dateStr);
                        setExcludedDates(prev => prev.filter(d => d !== dateStr));
                    } else {
                        await supabaseClient.from('excluded_dates').insert([{ date_str: dateStr }]);
                        setExcludedDates(prev => [...prev, dateStr]);
                    }
                } catch (err) { console.error(err); }
            };

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    setLoading(true);
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        const mapped = data.map(item => ({
                            event_date: typeof item['날짜'] === 'number' ? new Date((item['날짜'] - 25569) * 86400 * 1000).toISOString().split('T')[0] : (item['날짜'] || new Date().toISOString().split('T')[0]),
                            department: String(item['부서'] || '기타'),
                            event_name: String(item['행사명'] || '미지정 행사'),
                            total_participants: Number(item['참석인원'] || 0),
                            meal_participants: Number(item['급식인원'] || 0)
                        }));
                        const { error } = await supabaseClient.from('events').insert(mapped);
                        if (error) throw error;
                        showMsg(`${mapped.length}건 등록 완료`, "success");
                        initData();
                        setActiveTab('list');
                    } catch (err) { showMsg("파일 처리 오류", "error"); } finally { setLoading(false); if(fileInputRef.current) fileInputRef.current.value=""; }
                };
                reader.readAsBinaryString(file);
            };

            const handleSubmitEvent = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const { error } = await supabaseClient.from('events').insert([{
                        event_date: formData.event_date,
                        department: formData.department,
                        event_name: formData.event_name,
                        total_participants: Number(formData.total_participants),
                        meal_participants: Number(formData.meal_participants)
                    }]);
                    if (error) throw error;
                    setFormData({ ...formData, event_name: '', total_participants: 0, meal_participants: 0 });
                    showMsg("등록 성공", "success");
                    initData();
                    setActiveTab('list');
                } catch (err) { showMsg("등록 실패", "error"); } finally { setLoading(false); }
            };

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (pwInput === ADMIN_PASSWORD) {
                    setIsAdmin(true); setPwInput(""); showMsg("마스터 권한 활성화", "success");
                } else { showMsg("비밀번호 오류", "error"); }
            };

            const deleteEvent = async (id) => {
                if(!window.confirm("삭제하시겠습니까?")) return;
                setLoading(true);
                try {
                    const { error } = await supabaseClient.from('events').delete().eq('id', id);
                    if (error) throw error;
                    showMsg("삭제 완료", "success");
                    initData();
                } catch (err) { showMsg("삭제 실패", "error"); } finally { setLoading(false); }
            };

            const getMealTitle = () => {
                if (viewMode === 'day') return '일일 급식 총원';
                if (viewMode === 'week') return '주간 급식 총원';
                return '월간 급식 총원';
            };

            return (
                <div className="flex h-screen overflow-hidden bg-[#f8fafc] text-[#1C0770]">
                    {/* 알림 배너 */}
                    {notification && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] animate-fadeIn">
                            <div className="px-5 py-3 rounded-xl shadow-xl flex items-center space-x-3 bg-white border-l-4" style={{borderLeftColor: notification.type==='success'?COLORS.lime:COLORS.royal}}>
                                <Icon name={notification.type === 'error' ? "AlertTriangle" : "Info"} size={16} color={notification.type === 'error' ? '#ef4444' : '#261CC1'} />
                                <span className="font-bold text-xs">{notification.message}</span>
                            </div>
                        </div>
                    )}

                    {/* 사이드바 - 고정 */}
                    <nav className="w-64 bg-[#1C0770] text-white p-5 flex flex-col shrink-0 z-30 shadow-2xl overflow-y-auto">
                        <div className="mb-8 flex items-center space-x-3 px-1">
                            <div className="p-2 rounded-lg shadow flex items-center justify-center" style={{backgroundColor: COLORS.lime}}>
                                <Icon name="Utensils" size={20} color="#1C0770" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black italic leading-none">들락날락</h1>
                                <p className="text-[8px] text-[#3A9AFF] font-black uppercase mt-1 tracking-widest">창의융합교육원 CMS</p>
                            </div>
                        </div>
                        <div className="space-y-1 flex-1">
                            {[
                                { id: 'dashboard', icon: 'LayoutDashboard', label: '통계 대시보드' },
                                { id: 'list', icon: 'ListOrdered', label: '행사 내역 조회' },
                                { id: 'add', icon: 'PlusCircle', label: '신규 행사 등록' },
                                { id: 'admin', icon: 'Settings', label: '시스템 설정' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} 
                                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold text-xs ${activeTab === item.id ? 'sidebar-active' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                                    <Icon name={item.icon} size={16}/> <span>{item.label}</span>
                                </button>
                            ))}
                        </div>
                        <div className="mt-4 p-4 bg-white/5 rounded-xl border border-white/5 flex items-center justify-between">
                            <div className="flex flex-col text-slate-400">
                                <span className="text-[8px] font-bold uppercase tracking-tight">Access</span>
                                <span className="text-[10px] font-black text-white">{isAdmin ? 'ADMIN' : 'GUEST'}</span>
                            </div>
                            <Icon name="RefreshCcw" size={12} className={`${loading ? 'animate-spin' : ''} text-[#3A9AFF]`} />
                        </div>
                    </nav>

                    {/* 메인 섹션 */}
                    <main className="flex-1 flex flex-col min-w-0">
                        {/* 상단 헤더 */}
                        <header className="bg-white border-b border-slate-100 p-4 px-8 flex flex-col sm:flex-row items-center justify-between gap-4 z-20 shrink-0 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 px-4 py-2 bg-slate-50 rounded-xl border border-slate-100 shadow-inner">
                                    <Icon name="CalendarDays" size={16} color="#3A9AFF" />
                                    <span className="text-[#261CC1] font-black text-sm">{filteredData.periodLabel}</span>
                                </div>
                                <div className="flex bg-slate-100 p-1 rounded-xl">
                                    {['day', 'week', 'month'].map(m => (
                                        <button key={m} onClick={() => setViewMode(m)} className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${viewMode === m ? 'bg-white text-[#1C0770] shadow-sm' : 'text-slate-400 hover:text-[#261CC1]'}`}>
                                            {m === 'day' ? '일간' : m === 'week' ? '주간' : '월간'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex items-center bg-[#1C0770] rounded-xl shadow-lg overflow-hidden shrink-0 border border-[#1C0770]">
                                <button onClick={() => navigateDate(-1)} className="p-2.5 hover:bg-[#261CC1] transition text-white border-r border-white/10 group">
                                    <Icon name="ChevronLeft" size={24} color="white" />
                                </button>
                                <button onClick={() => {setViewDate(new Date()); setViewMode('day');}} className="px-6 py-2.5 text-[10px] font-black text-[#F1FF5E] hover:bg-[#261CC1] transition uppercase tracking-widest border-r border-white/10 active:scale-95">Today</button>
                                <button onClick={() => navigateDate(1)} className="p-2.5 hover:bg-[#261CC1] transition text-white group">
                                    <Icon name="ChevronRight" size={24} color="white" />
                                </button>
                            </div>
                        </header>

                        {/* 콘텐츠 영역 */}
                        <div className="content-area overflow-y-auto p-6 md:p-8 space-y-6">
                            {activeTab === 'dashboard' && (
                                <div className="max-w-7xl mx-auto space-y-6 animate-fadeIn pb-8">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-[2rem] shadow-sm border-b-4 border-[#261CC1] flex flex-col justify-between custom-shadow">
                                            <p className="text-[10px] font-black text-[#261CC1] uppercase tracking-widest flex items-center gap-2 italic"><Icon name="Users" size={14} color="#261CC1"/> Total Visitors</p>
                                            <div className="flex items-baseline space-x-1 mt-4">
                                                <h3 className="text-5xl font-black tracking-tighter text-[#1C0770]">{safeLocaleString(filteredData.summary.total)}</h3>
                                                <span className="text-slate-300 font-bold text-lg ml-2">명</span>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-[2rem] shadow-sm border-b-4 border-[#3A9AFF] flex flex-col justify-between custom-shadow">
                                            <p className="text-[10px] font-black text-[#3A9AFF] uppercase tracking-widest flex items-center gap-2 italic"><Icon name="CheckCircle2" size={14} color="#3A9AFF"/> {getMealTitle()}</p>
                                            <div className="flex items-baseline space-x-1 mt-4">
                                                <h3 className="text-5xl font-black tracking-tighter text-[#261CC1]">{safeLocaleString(filteredData.summary.meals)}</h3>
                                                <span className="text-slate-300 font-bold text-lg ml-2">명</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col custom-shadow overflow-hidden">
                                        <div className="flex items-center justify-between mb-6 shrink-0">
                                            <h3 className="text-xl font-black text-[#1C0770]">운영 상세 현황</h3>
                                            <div className="flex items-center gap-4 text-[9px] font-black uppercase text-slate-400">
                                                <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 bg-[#261CC1] rounded-full shadow-sm"></div> Guest</div>
                                                <div className="flex items-center gap-1.5 ml-2"><div className="w-2.5 h-2.5 bg-[#3A9AFF] rounded-full shadow-sm"></div> Meal</div>
                                                <div className="flex items-center gap-1.5 ml-2"><div className="w-2.5 h-2.5 bg-[#F1FF5E] rounded-full shadow-sm border border-slate-200"></div> Modified</div>
                                            </div>
                                        </div>
                                        
                                        <div className="overflow-y-auto pr-2 max-h-[450px] space-y-2">
                                            <div className="grid grid-cols-12 px-6 py-2 text-[9px] font-black text-slate-300 uppercase hidden md:grid tracking-widest sticky top-0 bg-white z-10 border-b border-slate-50 mb-2">
                                                <div className="col-span-2">Date</div>
                                                <div className="col-span-2 text-center">Visitors</div>
                                                <div className="col-span-2 text-center">Meals</div>
                                                <div className="col-span-2 text-center">Cap / Base</div>
                                                <div className="col-span-2 text-center">Remaining</div>
                                                <div className="col-span-2 text-right">Status</div>
                                            </div>
                                            {filteredData.items.map((item, i) => {
                                                const isOver = item.meals > item.capacity;
                                                return (
                                                    <div key={i} onClick={() => isAdmin && toggleExcludedDate(item.dateStr)}
                                                        className={`grid grid-cols-1 md:grid-cols-12 items-center px-6 py-3 rounded-2xl border transition-all ${isAdmin ? 'cursor-pointer hover:border-[#3A9AFF]/40 hover:shadow-md' : ''} ${!item.isOperating ? 'opacity-40 border-transparent off-day-pattern' : isOver ? 'bg-red-50/40 border-red-100 shadow-sm' : 'bg-white border-slate-50 shadow-sm'}`}>
                                                        <div className="col-span-1 md:col-span-2 flex items-center gap-2">
                                                            <div className="flex flex-col">
                                                                <span className={`text-sm font-black ${item.dayLabel === '일' ? 'text-red-500' : item.dayLabel === '토' ? 'text-[#3A9AFF]' : 'text-[#1C0770]'}`}>{item.dayLabel}요일</span>
                                                                <p className="text-[9px] font-bold text-slate-400">{item.shortDate}</p>
                                                            </div>
                                                            {item.isOverridden && <div className="w-1.5 h-1.5 bg-[#F1FF5E] rounded-full border border-[#1C0770]/20" title="수정된 기준값"></div>}
                                                        </div>
                                                        <div className="col-span-1 md:col-span-2 text-center font-black text-slate-600"><span className="text-[#261CC1]">{item.total}</span></div>
                                                        <div className="col-span-1 md:col-span-2 text-center font-black text-slate-600"><span className="text-[#3A9AFF]">{item.meals}</span></div>
                                                        <div className="col-span-1 md:col-span-2 text-center text-[10px] font-bold text-slate-400">
                                                            {item.capacity} / {item.baseCount}
                                                        </div>
                                                        <div className="col-span-1 md:col-span-2 text-center font-black text-[10px]">
                                                            <span className={item.remaining < 0 ? 'text-red-600 animate-pulse' : 'text-slate-400'}>{item.remaining} 여유</span>
                                                        </div>
                                                        <div className="col-span-1 md:col-span-2 text-right">
                                                            {item.isOperating ? <span className="text-[9px] bg-[#F1FF5E] text-[#1C0770] px-3 py-1 rounded-full font-black uppercase tracking-tighter border border-[#1C0770]/10">Open</span> : <span className="text-[9px] bg-slate-100 text-slate-400 px-3 py-1 rounded-full font-black uppercase tracking-tighter">Closed</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'admin' && (
                                <div className="max-w-7xl mx-auto space-y-8 animate-fadeIn pb-8">
                                    {!isAdmin ? (
                                        <div className="max-w-md mx-auto bg-white p-12 rounded-[3rem] shadow-2xl border border-slate-100 text-center space-y-8 custom-shadow mt-12">
                                            <div className="inline-flex p-5 bg-[#1C0770]/5 rounded-full text-[#1C0770]"><Icon name="Lock" size={40} strokeWidth={1.5} /></div>
                                            <div className="space-y-1"><h2 className="text-xl font-black italic text-[#1C0770]">Security Access</h2><p className="text-slate-400 font-bold text-xs uppercase tracking-widest">Master Authorization Required</p></div>
                                            <form onSubmit={handleAdminLogin} className="space-y-4">
                                                <input type="password" placeholder="Pass: 1416" value={pwInput} onChange={e => setPwInput(e.target.value)} className="w-full p-4 bg-[#f8fafc] border-2 border-transparent rounded-2xl text-center font-black text-xl focus:border-[#3A9AFF] outline-none transition shadow-inner tracking-widest" />
                                                <button type="submit" className="w-full bg-[#1C0770] text-white py-4 rounded-2xl font-black hover:bg-[#261CC1] shadow-xl transition-all text-xs uppercase tracking-widest">Login</button>
                                            </form>
                                        </div>
                                    ) : (
                                        <div className="space-y-8">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <h2 className="text-2xl font-black italic text-[#1C0770]">Master Panel</h2>
                                                    <span className="px-3 py-1 bg-[#F1FF5E] text-[#1C0770] rounded-full text-[9px] font-black uppercase tracking-tighter">Authorized</span>
                                                </div>
                                                <button onClick={() => { setIsAdmin(false); showMsg("로그아웃되었습니다."); }} className="px-6 py-2 bg-white text-red-600 rounded-xl text-[10px] font-black hover:bg-red-50 transition uppercase border border-red-100 shadow-sm active:scale-95">Logout</button>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                                                {/* 1. 전역 기본 설정 */}
                                                <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6 custom-shadow h-fit">
                                                    <div className="flex items-center space-x-3 pb-4 border-b border-slate-50"><Icon name="Save" size={20} color="#3A9AFF" /><h3 className="text-lg font-black text-[#1C0770]">전역 기본값</h3></div>
                                                    <div className="space-y-4">
                                                        <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Default Capacity</label><input type="number" value={baseSettings.maxCapacity} onChange={e => setBaseSettings({...baseSettings, maxCapacity: Number(e.target.value)})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base text-[#261CC1] shadow-inner border-none" /></div>
                                                        <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Default Base Count</label><input type="number" value={baseSettings.baseMealCount} onChange={e => setBaseSettings({...baseSettings, baseMealCount: Number(e.target.value)})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base text-[#3A9AFF] shadow-inner border-none" /></div>
                                                        <div className="space-y-1.5">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Workdays</label>
                                                            <div className="flex gap-1">
                                                                {WEEKDAYS.map((day, i) => (<button key={i} onClick={() => { const newDays = [...baseSettings.operatingDays]; newDays[i] = !newDays[i]; setBaseSettings({...baseSettings, operatingDays: newDays}); }} className={`flex-1 py-3 rounded-lg text-[10px] font-black transition-all ${baseSettings.operatingDays[i] ? 'bg-[#1C0770] text-white shadow-lg' : 'bg-slate-50 text-slate-300'}`}>{day}</button>))}
                                                            </div>
                                                        </div>
                                                        <button onClick={saveSettings} disabled={loading} className="w-full bg-[#1C0770] text-white py-4 rounded-xl font-black shadow-xl hover:bg-[#261CC1] transition-all text-xs flex items-center justify-center gap-3">
                                                            <Icon name={loading ? "RefreshCcw" : "Check"} size={16} color={loading ? "#3A9AFF" : "#F1FF5E"} className={loading ? "animate-spin" : ""} />
                                                            <span>기본값 저장</span>
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* 2. 특정 일자별 개별 설정 */}
                                                <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6 custom-shadow h-fit">
                                                    <div className="flex items-center space-x-3 pb-4 border-b border-slate-50"><Icon name="Calendar" size={20} color="#261CC1" /><h3 className="text-lg font-black text-[#1C0770]">특정 일자 개별 설정</h3></div>
                                                    <form onSubmit={handleSaveSpecificOverride} className="space-y-4">
                                                        <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Target Date</label><input type="date" required value={specificOverride.date} onChange={e => setSpecificOverride({...specificOverride, date: e.target.value})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-bold text-sm shadow-inner border-none" /></div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-[#261CC1] uppercase ml-1 tracking-tighter">Capacity</label><input type="number" value={specificOverride.capacity} onChange={e => setSpecificOverride({...specificOverride, capacity: e.target.value})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base shadow-inner border-none" /></div>
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-[#3A9AFF] uppercase ml-1 tracking-tighter">Base Count</label><input type="number" value={specificOverride.baseCount} onChange={e => setSpecificOverride({...specificOverride, baseCount: e.target.value})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base shadow-inner border-none" /></div>
                                                        </div>
                                                        <button type="submit" disabled={loading} className="w-full bg-[#261CC1] text-white py-4 rounded-xl font-black shadow-xl hover:bg-[#1C0770] transition-all text-xs flex items-center justify-center gap-3">
                                                            <Icon name="PlusCircle" size={16} color="#F1FF5E" />
                                                            <span>일자별 적용</span>
                                                        </button>
                                                    </form>
                                                </div>

                                                {/* 3. 기간/요일별 일괄 설정 */}
                                                <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6 custom-shadow h-fit">
                                                    <div className="flex items-center space-x-3 pb-4 border-b border-slate-50"><Icon name="ListOrdered" size={20} color="#F1FF5E" /><h3 className="text-lg font-black text-[#1C0770]">기간/요일 일괄 설정</h3></div>
                                                    <form onSubmit={handleSaveRangeOverride} className="space-y-4">
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase ml-1 tracking-tighter">Start Date</label><input type="date" required value={rangeOverride.startDate} onChange={e => setRangeOverride({...rangeOverride, startDate: e.target.value})} className="w-full p-3 bg-[#f8fafc] rounded-xl font-bold text-[11px] shadow-inner border-none" /></div>
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase ml-1 tracking-tighter">End Date</label><input type="date" required value={rangeOverride.endDate} onChange={e => setRangeOverride({...rangeOverride, endDate: e.target.value})} className="w-full p-3 bg-[#f8fafc] rounded-xl font-bold text-[11px] shadow-inner border-none" /></div>
                                                        </div>
                                                        <div className="space-y-1.5">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Target Weekdays</label>
                                                            <div className="flex gap-1">
                                                                {WEEKDAYS.map((day, i) => (<button type="button" key={i} onClick={() => { const newDays = [...rangeOverride.days]; newDays[i] = !newDays[i]; setRangeOverride({...rangeOverride, days: newDays}); }} className={`flex-1 py-2.5 rounded-lg text-[9px] font-black transition-all ${rangeOverride.days[i] ? 'bg-[#3A9AFF] text-white shadow-md' : 'bg-slate-50 text-slate-300'}`}>{day}</button>))}
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-[#261CC1] uppercase ml-1 tracking-tighter">Capacity</label><input type="number" value={rangeOverride.capacity} onChange={e => setRangeOverride({...rangeOverride, capacity: e.target.value})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base shadow-inner border-none" /></div>
                                                            <div className="space-y-1.5"><label className="text-[9px] font-black text-[#3A9AFF] uppercase ml-1 tracking-tighter">Base Count</label><input type="number" value={rangeOverride.baseCount} onChange={e => setRangeOverride({...rangeOverride, baseCount: e.target.value})} className="w-full p-3.5 bg-[#f8fafc] rounded-xl font-black text-base shadow-inner border-none" /></div>
                                                        </div>
                                                        <button type="submit" disabled={loading} className="w-full bg-[#3A9AFF] text-white py-4 rounded-xl font-black shadow-xl hover:bg-[#261CC1] transition-all text-xs flex items-center justify-center gap-3">
                                                            <Icon name="RefreshCcw" size={16} color="#F1FF5E" />
                                                            <span>일괄 업데이트</span>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>

                                            {/* 기존 휴무일 제어 섹션은 대시보드 리스트 클릭 방식으로 유지 */}
                                            <div className="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 custom-shadow flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className="p-3 bg-[#F1FF5E]/20 rounded-2xl"><Icon name="Info" size={24} color="#1C0770" /></div>
                                                    <div>
                                                        <h4 className="font-black text-[#1C0770]">Live 제어 안내</h4>
                                                        <p className="text-xs text-slate-400 font-bold">대시보드 리스트의 날짜 행을 클릭하면 해당 일자의 휴무 여부를 즉시 전환할 수 있습니다.</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 text-[#3A9AFF] font-black text-[10px] uppercase italic tracking-widest animate-pulse">
                                                    <div className="w-2 h-2 bg-[#F1FF5E] rounded-full"></div> Master Active
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* 나머지 탭 생략... (List, Add 등) */}
                            {activeTab === 'add' && (
                                <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn pb-8">
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6 flex flex-col custom-shadow h-fit">
                                        <div className="flex items-center space-x-3 pb-4 border-b border-slate-50">
                                            <Icon name="FileText" size={22} color="#3A9AFF" />
                                            <h3 className="text-lg font-black text-[#1C0770]">수동 개별 등록</h3>
                                        </div>
                                        <form onSubmit={handleSubmitEvent} className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="date" required className="p-3.5 bg-slate-50 rounded-xl font-bold border-none outline-none shadow-inner text-xs" value={formData.event_date} onChange={e => setFormData({...formData, event_date: e.target.value})} />
                                                <select className="p-3.5 bg-slate-50 rounded-xl font-bold border-none outline-none shadow-inner cursor-pointer text-xs" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})}>{["기획부", "창의부", "정보부", "총무부"].map(d => <option key={d} value={d}>{d}</option>)}</select>
                                            </div>
                                            <input type="text" required placeholder="행사 명칭 입력" className="w-full p-3.5 bg-slate-50 rounded-xl font-bold border-none outline-none shadow-inner text-xs" value={formData.event_name} onChange={e => setFormData({...formData, event_name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-1"><label className="text-[9px] px-2 font-black text-slate-400 uppercase">방문인원</label><input type="number" className="w-full p-3.5 bg-slate-50 rounded-xl font-black shadow-inner border-none outline-none text-sm" value={formData.total_participants} onChange={e => setFormData({...formData, total_participants: Number(e.target.value)})} /></div>
                                                <div className="space-y-1"><label className="text-[9px] px-2 font-black text-[#3A9AFF] uppercase">급식인원</label><input type="number" className="w-full p-3.5 bg-slate-50 rounded-xl font-black text-[#261CC1] shadow-inner border-none outline-none text-sm" value={formData.meal_participants} onChange={e => setFormData({...formData, meal_participants: Number(e.target.value)})} /></div>
                                            </div>
                                            <button type="submit" className="w-full bg-[#1C0770] text-white py-4 rounded-2xl font-black shadow-lg hover:bg-[#261CC1] transition-all flex items-center justify-center space-x-3 text-sm active:scale-[0.98]">
                                                <Icon name="PlusCircle" size={18} color="#F1FF5E" />
                                                <span>데이터 저장</span>
                                            </button>
                                        </form>
                                    </div>

                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6 flex flex-col custom-shadow h-fit">
                                        <div className="flex items-center space-x-3 pb-4 border-b border-slate-50">
                                            <Icon name="FileSpreadsheet" size={22} color="#261CC1" />
                                            <h3 className="text-lg font-black text-[#1C0770]">엑셀 일괄 업로드</h3>
                                        </div>
                                        <div className="bg-[#1C0770]/5 rounded-2xl p-5 space-y-2 border border-[#1C0770]/5">
                                            <p className="text-[10px] text-slate-600 font-bold">1. 첫 번째 시트의 헤더를 읽습니다.</p>
                                            <p className="text-[10px] text-slate-600 font-bold">2. 필수 컬럼: 날짜, 부서, 행사명, 참석인원, 급식인원</p>
                                        </div>
                                        <div className="p-8 border-2 border-dashed border-[#3A9AFF]/20 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-center space-y-4 hover:border-[#3A9AFF]/60 transition-all group">
                                            <div className="p-4 bg-white rounded-xl shadow-sm text-[#3A9AFF] group-hover:scale-110 transition-transform"><Icon name="Upload" size={32} /></div>
                                            <input type="file" accept=".xlsx, .xls" ref={fileInputRef} onChange={handleExcelUpload} className="hidden" id="excel-upload" />
                                            <label htmlFor="excel-upload" className="px-8 py-3 bg-[#1C0770] text-white rounded-xl font-black cursor-pointer hover:bg-[#261CC1] transition-all text-[10px] uppercase tracking-widest shadow-lg">Upload Excel</label>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'list' && (
                                <div className="max-w-7xl mx-auto animate-fadeIn pb-8">
                                    <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden custom-shadow">
                                        <div className="p-6 px-10 flex items-center justify-between border-b border-slate-50">
                                            <h2 className="text-xl font-black italic text-[#1C0770] uppercase">Event Archive</h2>
                                            <span className="text-[10px] font-black text-[#261CC1] bg-slate-50 px-3 py-1 rounded-lg">Total: {events.length}</span>
                                        </div>
                                        <div className="overflow-y-auto max-h-[550px]">
                                            <table className="w-full text-left">
                                                <thead className="bg-[#1C0770] text-white sticky top-0 z-10">
                                                    <tr>
                                                        <th className="px-8 py-4 text-[10px] font-black uppercase text-center">Date</th>
                                                        <th className="px-8 py-4 text-[10px] font-black uppercase">Dept</th>
                                                        <th className="px-8 py-4 text-[10px] font-black uppercase">Event</th>
                                                        <th className="px-8 py-4 text-[10px] font-black uppercase text-center">Meals</th>
                                                        <th className="px-8 py-4 text-[10px] font-black uppercase text-center">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {events.length === 0 ? (
                                                        <tr><td colSpan="5" className="px-8 py-20 text-center text-slate-300 font-bold italic">No Data</td></tr>
                                                    ) : (
                                                        [...events].reverse().map(ev => (
                                                            <tr key={ev.id} className="hover:bg-slate-50/50 transition">
                                                                <td className="px-8 py-4 text-xs font-bold text-slate-400 text-center">{ev.event_date}</td>
                                                                <td className="px-8 py-4"><span className="text-[9px] font-black bg-[#261CC1]/10 text-[#261CC1] px-3 py-1 rounded-full uppercase">{ev.department}</span></td>
                                                                <td className="px-8 py-4 text-sm font-black text-[#1C0770]">{ev.event_name}</td>
                                                                <td className="px-8 py-4 text-center text-sm font-black text-[#3A9AFF]">{ev.meal_participants}명</td>
                                                                <td className="px-8 py-4 text-center"><button onClick={() => deleteEvent(ev.id)} className="p-2.5 rounded-lg transition-all text-red-300 hover:bg-red-50 hover:text-red-500 active:scale-90"><Icon name="Trash2" size={18}/></button></td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
