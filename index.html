import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  LayoutDashboard, 
  PlusCircle, 
  ListOrdered, 
  Utensils, 
  Trash2, 
  RefreshCcw, 
  ChevronLeft, 
  ChevronRight, 
  Settings, 
  CalendarX, 
  AlertTriangle,
  Coffee,
  Users,
  CheckCircle2,
  Lock,
  Save,
  Calendar as CalendarIcon,
  FileSpreadsheet,
  Upload,
  FileText,
  XCircle,
  Info,
  CalendarDays,
  HelpCircle,
  Check
} from 'lucide-react';

// Supabase 접속 정보
const SUPABASE_URL = 'https://zyuybhszykxuafzriksn.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_3h3_2LRYgdyeXdoDO6XZMA_4jQrQTtV'; 

const WEEKDAYS = ["일", "월", "화", "수", "목", "금", "토"];
const ADMIN_PASSWORD = "1416";

// 대표 색상 상수화
const COLORS = {
  deep: '#1C0770',
  royal: '#261CC1',
  sky: '#3A9AFF',
  lime: '#F1FF5E'
};

export default function App() {
  const [supabase, setSupabase] = useState(null);
  const [xlsxReady, setXlsxReady] = useState(false);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(false);
  const [viewMode, setViewMode] = useState('day');
  const [viewDate, setViewDate] = useState(new Date());
  
  const [notification, setNotification] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [pwInput, setPwInput] = useState("");

  const [baseSettings, setBaseSettings] = useState({ 
    maxCapacity: 220, 
    baseMealCount: 45,
    operatingDays: [false, true, true, true, true, true, false]
  });
  const [excludedDates, setExcludedDates] = useState([]);

  const [formData, setFormData] = useState({
    event_date: new Date().toISOString().split('T')[0],
    department: '기획부',
    event_name: '',
    total_participants: 0,
    meal_participants: 0
  });

  const fileInputRef = useRef(null);

  const showMsg = (message, type = 'info') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  useEffect(() => {
    const loadSupabase = () => {
      if (window.supabase) {
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        setSupabase(client);
      } else {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.async = true;
        script.onload = () => {
          if (window.supabase) {
            const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            setSupabase(client);
          }
        };
        document.head.appendChild(script);
      }
    };

    const loadXlsx = () => {
      if (window.XLSX) {
        setXlsxReady(true);
      } else {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.async = true;
        script.onload = () => setXlsxReady(true);
        document.head.appendChild(script);
      }
    };

    loadSupabase();
    loadXlsx();
  }, []);

  const initData = async (client) => {
    if (!client) return;
    setLoading(true);
    try {
      const { data: settingsData } = await client.from('site_settings').select('*').eq('id', 1).single();
      if (settingsData) {
        setBaseSettings({
          maxCapacity: Number(settingsData.max_capacity || 0),
          baseMealCount: Number(settingsData.base_meal_count || 0),
          operatingDays: settingsData.operating_days || [false, true, true, true, true, true, false]
        });
      }
      const { data: exclData } = await client.from('excluded_dates').select('date_str');
      if (exclData) setExcludedDates(exclData.map(d => d.date_str));
      const { data: eventData } = await client.from('events').select('*').order('event_date', { ascending: true });
      if (eventData) setEvents(eventData);
    } catch (err) {
      console.error("Data Load Error:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (supabase) initData(supabase);
  }, [supabase]);

  const navigateDate = (direction) => {
    const nextDate = new Date(viewDate);
    if (viewMode === 'day') nextDate.setDate(viewDate.getDate() + direction);
    else if (viewMode === 'week') nextDate.setDate(viewDate.getDate() + (direction * 7));
    else if (viewMode === 'month') nextDate.setMonth(viewDate.getMonth() + direction);
    setViewDate(nextDate);
  };

  const filteredData = useMemo(() => {
    const start = new Date(viewDate);
    const end = new Date(viewDate);
    start.setHours(0, 0, 0, 0);
    end.setHours(23, 59, 59, 999);

    if (viewMode === 'week') {
      const day = start.getDay();
      start.setDate(start.getDate() - day);
      const lastDay = new Date(start);
      lastDay.setDate(start.getDate() + 6);
      end.setTime(lastDay.getTime());
      end.setHours(23, 59, 59, 999);
    } else if (viewMode === 'month') {
      start.setDate(1); 
      end.setMonth(start.getMonth() + 1); 
      end.setDate(0);
      end.setHours(23, 59, 59, 999);
    }

    let rangeDays = [];
    const tempDate = new Date(start);
    while (tempDate <= end) {
      const dateStr = tempDate.toISOString().split('T')[0];
      const dayIdx = tempDate.getDay();
      const isOperating = baseSettings.operatingDays[dayIdx] && !excludedDates.includes(dateStr);
      const dayEvents = events.filter(e => e.event_date === dateStr);
      const sumVisitors = dayEvents.reduce((s, e) => s + Number(e.total_participants || 0), 0);
      const sumVisitorMeals = dayEvents.reduce((s, e) => s + Number(e.meal_participants || 0), 0);
      const totalMeals = isOperating ? (Number(baseSettings.baseMealCount) + sumVisitorMeals) : 0;
      const remaining = isOperating ? (baseSettings.maxCapacity - totalMeals) : 0;

      rangeDays.push({
        dateStr,
        dayLabel: WEEKDAYS[dayIdx],
        shortDate: `${tempDate.getMonth() + 1}/${tempDate.getDate()}`,
        isOperating,
        total: sumVisitors,
        meals: totalMeals,
        remaining,
        events: dayEvents
      });
      tempDate.setDate(tempDate.getDate() + 1);
    }

    const summaryTotal = rangeDays.reduce((sum, d) => sum + Number(d.total || 0), 0);
    const summaryMeals = rangeDays.reduce((sum, d) => sum + Number(d.meals || 0), 0);

    return {
      items: rangeDays,
      summary: { total: summaryTotal, meals: summaryMeals },
      periodLabel: viewMode === 'month' ? `${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월` : 
                   viewMode === 'day' ? `${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월 ${viewDate.getDate()}일` :
                   `${start.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })} ~ ${end.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })}`
    };
  }, [events, viewMode, viewDate, baseSettings, excludedDates]);

  const saveBaseSettings = async () => {
    if (!supabase) return;
    setLoading(true);
    try {
      const { error } = await supabase.from('site_settings').update({
        max_capacity: Number(baseSettings.maxCapacity || 0),
        base_meal_count: Number(baseSettings.baseMealCount || 0),
        operating_days: baseSettings.operating_days
      }).eq('id', 1);
      if (error) throw error;
      showMsg("운영 설정이 저장되었습니다.", "success");
    } catch (err) { showMsg(err.message, "error"); } finally { setLoading(false); }
  };

  const toggleExcludedDate = async (dateStr) => {
    if (!isAdmin || !supabase) {
      showMsg("휴무일 지정은 관리자 인증이 필요합니다.", "error");
      return;
    }
    try {
      if (excludedDates.includes(dateStr)) {
        await supabase.from('excluded_dates').delete().eq('date_str', dateStr);
        setExcludedDates(prev => prev.filter(d => d !== dateStr));
      } else {
        await supabase.from('excluded_dates').insert([{ date_str: dateStr }]);
        setExcludedDates(prev => [...prev, dateStr]);
      }
    } catch (err) { console.error(err); }
  };

  const handleAdminLogin = (e) => {
    e.preventDefault();
    if (pwInput === ADMIN_PASSWORD) { 
      setIsAdmin(true); 
      setPwInput(""); 
      showMsg("관리자로 인증되었습니다.", "success");
    } 
    else showMsg("비밀번호가 틀렸습니다.", "error");
  };

  const handleSubmitEvent = async (e) => {
    e.preventDefault();
    if (!supabase) return;
    setLoading(true);
    try {
      const payload = {
        ...formData,
        total_participants: Number(formData.total_participants || 0),
        meal_participants: Number(formData.meal_participants || 0)
      };
      const { error } = await supabase.from('events').insert([payload]);
      if (error) throw error;
      setFormData({ ...formData, event_name: '', total_participants: 0, meal_participants: 0 });
      initData(supabase);
      setActiveTab('list');
      showMsg("행사가 성공적으로 등록되었습니다.", "success");
    } catch (err) { showMsg(err.message, "error"); } finally { setLoading(false); }
  };

  const handleExcelUpload = (e) => {
    const file = e.target.files[0];
    if (!file || !xlsxReady || !supabase) return;

    const reader = new FileReader();
    reader.onload = async (evt) => {
      setLoading(true);
      try {
        const bstr = evt.target.result;
        const wb = window.XLSX.read(bstr, { type: 'binary' });
        const wsname = wb.SheetNames[0];
        const ws = wb.Sheets[wsname];
        const data = window.XLSX.utils.sheet_to_json(ws);

        const mappedData = data.map(item => {
          let dateVal = item['날짜'];
          if (typeof dateVal === 'number') {
            const date = new Date((dateVal - 25569) * 86400 * 1000);
            dateVal = date.toISOString().split('T')[0];
          }
          return {
            event_date: dateVal || new Date().toISOString().split('T')[0],
            department: String(item['부서'] || '기타'),
            event_name: String(item['행사명'] || '미지정 행사'),
            total_participants: Number(item['참석인원'] || 0),
            meal_participants: Number(item['급식인원'] || 0)
          };
        });

        if (mappedData.length > 0) {
          const { error } = await supabase.from('events').insert(mappedData);
          if (error) throw error;
          showMsg(`${mappedData.length}건 일괄 등록 성공`, "success");
          initData(supabase);
          setActiveTab('list');
        }
      } catch (err) {
        showMsg(`업로드 실패: ${err.message}`, "error");
      } finally {
        setLoading(false);
        if (fileInputRef.current) fileInputRef.current.value = "";
      }
    };
    reader.readAsBinaryString(file);
  };

  const deleteEvent = async (id) => {
    if (!supabase) return;
    if(!window.confirm("행사 내역을 삭제하시겠습니까?")) return;
    setLoading(true);
    try {
      const { error } = await supabase.from('events').delete().eq('id', id);
      if (error) throw error;
      showMsg("삭제되었습니다.", "success");
      initData(supabase);
    } catch (err) { showMsg(err.message, "error"); } finally { setLoading(false); }
  };

  const offDayStyle = {
    background: `repeating-linear-gradient(45deg, #f8fafc, #f8fafc 10px, #f1f5f9 10px, #f1f5f9 20px)`,
  };

  const safeLocaleString = (val) => (Number(val) || 0).toLocaleString();

  const getMealTitle = () => {
    switch (viewMode) {
      case 'day': return '일일 급식 예상 총원';
      case 'week': return '주간 급식 예상 총원';
      case 'month': return '월간 급식 예상 총원';
      default: return '실제 급식 예상 총원';
    }
  };

  if (!supabase) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 font-sans">
        <div className="text-center space-y-4">
          <RefreshCcw size={48} className="animate-spin text-[#3A9AFF] mx-auto" />
          <p className="text-slate-500 font-bold">시스템 엔진 시동 중...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col md:flex-row bg-[#f8fafc] text-[#1C0770] font-sans relative">
      <style>{`
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .sidebar-item-active { background-color: ${COLORS.royal}; color: white; box-shadow: 0 10px 15px -3px rgba(38, 28, 193, 0.3); }
        .custom-shadow { box-shadow: 0 4px 20px rgba(28, 7, 112, 0.05); }
      `}</style>
      
      {notification && (
        <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[100] animate-fadeIn">
          <div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center space-x-3 border ${
            notification.type === 'error' ? 'bg-red-50 border-red-200 text-red-600' : 
            notification.type === 'success' ? `bg-white border-[${COLORS.lime}] text-[${COLORS.deep}]` : 
            'bg-white border-slate-200 text-slate-600'
          }`} style={notification.type === 'success' ? {borderLeft: `6px solid ${COLORS.lime}`} : {}}>
            {notification.type === 'error' ? <XCircle size={18}/> : <Info size={18}/>}
            <span className="font-black text-sm">{notification.message}</span>
          </div>
        </div>
      )}

      <nav className={`w-full md:w-72 bg-[#1C0770] text-white p-6 flex flex-col shrink-0 z-30 transition-all shadow-2xl`}>
        <div className="mb-10 flex items-center space-x-3">
          <div className={`bg-[${COLORS.lime}] p-2 rounded-xl shadow-lg`} style={{backgroundColor: COLORS.lime}}>
            <Utensils size={24} color={COLORS.deep} strokeWidth={2.5} />
          </div>
          <div>
            <h1 className="text-2xl font-black text-white leading-none tracking-tighter italic">들락날락</h1>
            <p className="text-[10px] text-[#3A9AFF] font-bold uppercase tracking-widest mt-1">창의융합교육원</p>
          </div>
        </div>
        
        <div className="space-y-1.5 flex-1">
          {[
            { id: 'dashboard', icon: <LayoutDashboard size={18}/>, label: '통계 대시보드' },
            { id: 'list', icon: <ListOrdered size={18}/>, label: '행사 내역 조회' },
            { id: 'add', icon: <PlusCircle size={18}/>, label: '신규 행사 등록' },
            { id: 'admin', icon: <Settings size={18}/>, label: '시스템 설정' }
          ].map(item => (
            <button key={item.id} onClick={() => setActiveTab(item.id)} 
              className={`w-full flex items-center space-x-3 px-5 py-4 rounded-2xl transition-all font-bold text-sm ${activeTab === item.id ? 'sidebar-item-active' : 'text-slate-400 hover:bg-[#261CC1]/20 hover:text-white'}`}>
              {item.icon} <span>{item.label}</span>
            </button>
          ))}
        </div>

        <div className="mt-6 p-5 bg-white/5 rounded-2xl border border-white/10">
          <div className="flex items-center space-x-2 text-slate-400">
            <RefreshCcw size={12} className={loading ? "animate-spin" : ""} />
            <span className="text-[10px] font-bold uppercase tracking-tighter">{isAdmin ? 'Administrator' : 'Standard Access'}</span>
          </div>
        </div>
      </nav>

      <main className="flex-1 p-6 md:p-10 overflow-y-auto bg-[#f8fafc]">
        {activeTab === 'dashboard' && (
          <div className="max-w-6xl mx-auto space-y-8 animate-fadeIn">
            <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
              <div>
                <h2 className="text-3xl font-black text-[#1C0770] tracking-tight">현황 모니터링</h2>
                <div className="flex items-center gap-2.5 mt-3 px-4 py-2 bg-white w-fit rounded-xl border border-slate-100 shadow-sm">
                  <CalendarDays size={18} className="text-[#3A9AFF]" />
                  <span className="text-[#261CC1] font-black text-sm tracking-tight">{filteredData.periodLabel}</span>
                  <div className="w-1.5 h-1.5 bg-[#F1FF5E] rounded-full animate-pulse border border-[#1C0770]/10"></div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
                  {['day', 'week', 'month'].map(mode => (
                    <button key={mode} onClick={() => setViewMode(mode)}
                      className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all ${viewMode === mode ? `bg-[${COLORS.deep}] text-white shadow-xl` : 'text-slate-400 hover:text-[#261CC1]'}`}
                      style={viewMode === mode ? {backgroundColor: COLORS.deep} : {}}>
                      {mode === 'day' ? '일간' : mode === 'week' ? '주간' : '월간'}
                    </button>
                  ))}
                </div>
                <div className="flex items-center bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm">
                  <button onClick={() => navigateDate(-1)} className="p-3 hover:bg-slate-50 border-r border-slate-50 transition text-[#1C0770]"><ChevronLeft size={20}/></button>
                  <button 
                    onClick={() => { setViewDate(new Date()); setViewMode('day'); }} 
                    className="px-5 text-xs font-black text-[#3A9AFF] hover:bg-[#3A9AFF] hover:text-white transition uppercase tracking-widest"
                  >Today</button>
                  <button onClick={() => navigateDate(1)} className="p-3 hover:bg-slate-50 border-l border-slate-50 transition text-[#1C0770]"><ChevronRight size={20}/></button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 flex flex-col justify-between group hover:border-[#261CC1]/20 transition-all border-b-[8px]" style={{borderBottomColor: COLORS.royal}}>
                <p className="text-[12px] font-black text-[#261CC1] uppercase tracking-widest mb-6 flex items-center gap-2">
                  <Users size={16}/> 총 방문객 집계
                </p>
                <div className="flex items-baseline space-x-1">
                  <h3 className="text-7xl font-black text-[#1C0770] tracking-tighter">{safeLocaleString(filteredData.summary.total)}</h3>
                  <span className="text-slate-400 font-bold text-xl ml-2">명</span>
                </div>
              </div>
              <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 flex flex-col justify-between relative overflow-hidden group hover:border-[#3A9AFF]/20 transition-all border-b-[8px]" style={{borderBottomColor: COLORS.sky}}>
                <p className="text-[12px] font-black text-[#3A9AFF] uppercase tracking-widest mb-6 flex items-center gap-2">
                  <CheckCircle2 size={16}/> {getMealTitle()}
                </p>
                <div className="flex items-baseline space-x-1">
                  <h3 className="text-7xl font-black text-[#261CC1] tracking-tighter">{safeLocaleString(filteredData.summary.meals)}</h3>
                  <span className="text-slate-400 font-bold text-xl ml-2">명</span>
                </div>
              </div>
            </div>

            <div className="bg-white p-8 md:p-12 rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden relative">
              <div className="flex items-center justify-between mb-10">
                <h3 className="text-2xl font-black text-[#1C0770] tracking-tight">데일리 운영 추이</h3>
                <div className="flex gap-4 bg-slate-50 p-3 px-6 rounded-2xl border border-slate-100 shadow-inner">
                   <div className="flex items-center text-[10px] font-bold text-[#261CC1]"><div className="w-3 h-3 bg-[#261CC1] rounded-full mr-2"></div>방문객</div>
                   <div className="flex items-center text-[10px] font-bold text-[#3A9AFF]"><div className="w-3 h-3 bg-[#3A9AFF] rounded-full mr-2"></div>식수</div>
                </div>
              </div>
              <div className="space-y-4">
                <div className="grid grid-cols-12 px-8 py-2 text-[10px] font-black text-slate-400 uppercase hidden md:grid tracking-widest">
                  <div className="col-span-2">날짜 정보</div>
                  <div className="col-span-3">총 방문객</div>
                  <div className="col-span-3">예상 급식인원</div>
                  <div className="col-span-2">잔여 수용량</div>
                  <div className="col-span-2 text-right">운영 현황</div>
                </div>

                {filteredData.items.map((item, i) => {
                  const isOver = item.meals > (Number(baseSettings.maxCapacity) || 0);
                  return (
                    <div key={i} onClick={() => isAdmin && toggleExcludedDate(item.dateStr)}
                      className={`grid grid-cols-1 md:grid-cols-12 items-center px-8 py-5 rounded-[2rem] border transition-all ${isAdmin ? 'cursor-pointer hover:border-[#3A9AFF]/40 hover:shadow-xl hover:-translate-y-1' : ''} ${!item.isOperating ? 'bg-slate-50 opacity-60 border-transparent' : isOver ? 'bg-red-50/20 border-red-100 shadow-sm shadow-red-50' : 'bg-white border-slate-100 custom-shadow'}`}
                      style={!item.isOperating ? offDayStyle : {}}>
                      <div className="col-span-1 md:col-span-2">
                        <span className={`text-base font-black ${item.dayLabel === '일' ? 'text-red-500' : item.dayLabel === '토' ? 'text-[#3A9AFF]' : 'text-[#1C0770]'}`}>{item.dayLabel}요일</span>
                        <p className="text-[11px] font-bold text-slate-400">{item.shortDate}</p>
                      </div>
                      <div className="col-span-1 md:col-span-3 font-bold text-slate-600 flex items-center gap-2"><Users size={14} className="text-[#261CC1] opacity-40"/> <span className="text-[#1C0770]">{item.total}</span>명</div>
                      <div className="col-span-1 md:col-span-3 font-black text-[#261CC1] flex items-center gap-2"><Utensils size={14} className="text-[#3A9AFF] opacity-50"/> <span>{item.meals}</span>명</div>
                      <div className="col-span-1 md:col-span-2">
                        <div className={`px-4 py-1.5 w-fit rounded-full text-[11px] font-black border ${item.remaining < 0 ? 'bg-red-50 text-red-600 border-red-100' : 'bg-[#3A9AFF]/10 text-[#3A9AFF] border-[#3A9AFF]/20'}`}>
                          {item.remaining}명 남음
                        </div>
                      </div>
                      <div className="col-span-1 md:col-span-2 text-right">
                        {item.isOperating ? 
                          <span className={`text-[10px] bg-[${COLORS.lime}] text-[${COLORS.deep}] px-4 py-1.5 rounded-full font-black uppercase tracking-tighter shadow-sm border border-[${COLORS.lime}]`} style={{backgroundColor: COLORS.lime, color: COLORS.deep}}>Open Now</span> : 
                          <span className="text-[10px] bg-white text-slate-300 px-4 py-1.5 rounded-full font-black uppercase tracking-tighter border border-slate-100">Closed</span>
                        }
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'add' && (
          <div className="max-w-6xl mx-auto space-y-12 animate-fadeIn">
            <div className="text-center">
              <h2 className="text-4xl font-black text-[#1C0770] tracking-tighter italic uppercase">Quick Entry</h2>
              <p className="text-slate-400 font-bold mt-2">등록 방식을 선택하여 새로운 일정을 추가하세요.</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
              <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8 flex flex-col">
                <div className="flex items-center space-x-3 pb-4 border-b border-slate-50">
                  <FileText size={24} className="text-[#3A9AFF]" />
                  <h3 className="text-xl font-black text-[#1C0770]">수동 개별 등록</h3>
                </div>
                <form onSubmit={handleSubmitEvent} className="space-y-6 flex-1 flex flex-col justify-between">
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <input type="date" required className="p-4 bg-[#f8fafc] rounded-2xl font-bold border-none focus:ring-2 focus:ring-[#3A9AFF] transition shadow-inner" value={formData.event_date} onChange={e => setFormData({...formData, event_date: e.target.value})} />
                      <select className="p-4 bg-[#f8fafc] rounded-2xl font-bold border-none focus:ring-2 focus:ring-[#3A9AFF] cursor-pointer shadow-inner" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})}>
                        {["기획부", "창의부", "정보부", "총무부"].map(d => <option key={d} value={d}>{d}</option>)}
                      </select>
                    </div>
                    <input type="text" required placeholder="행사 명칭을 입력해 주세요" className="w-full p-4 bg-[#f8fafc] rounded-2xl font-bold border-none focus:ring-2 focus:ring-[#3A9AFF] transition shadow-inner" value={formData.event_name} onChange={e => setFormData({...formData, event_name: e.target.value})} />
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-1">
                        <label className="text-[10px] px-2 font-black text-slate-400 uppercase tracking-widest">방문 인원</label>
                        <input type="number" className="w-full p-4 bg-[#f8fafc] rounded-2xl font-black border-none focus:ring-2 focus:ring-[#3A9AFF] shadow-inner" value={formData.total_participants} onChange={e => setFormData({...formData, total_participants: Number(e.target.value)})} />
                      </div>
                      <div className="space-y-1">
                        <label className="text-[10px] px-2 font-black text-[#3A9AFF] uppercase tracking-widest">급식 인원</label>
                        <input type="number" className="w-full p-4 bg-[#f8fafc] rounded-2xl font-black text-[#261CC1] border-none focus:ring-2 focus:ring-[#3A9AFF] shadow-inner" value={formData.meal_participants} onChange={e => setFormData({...formData, meal_participants: Number(e.target.value)})} />
                      </div>
                    </div>
                  </div>
                  <button type="submit" className="mt-8 w-full bg-[#1C0770] text-white py-5 rounded-3xl font-black shadow-xl hover:bg-[#261CC1] transition-all flex items-center justify-center space-x-3 group">
                    <PlusCircle size={20} className="text-[#F1FF5E] group-hover:rotate-90 transition-transform"/>
                    <span>행사 내역 저장하기</span>
                  </button>
                </form>
              </div>

              <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8">
                <div className="flex items-center space-x-3 pb-4 border-b border-slate-50">
                  <FileSpreadsheet size={24} className="text-[#261CC1]" />
                  <h3 className="text-xl font-black text-[#1C0770]">엑셀 일괄 등록</h3>
                </div>
                
                {/* 엑셀 업로드 가이드 문구 추가 */}
                <div className="space-y-6">
                  <div className="bg-slate-50 rounded-[2rem] p-6 border border-slate-100 space-y-4">
                    <div className="flex items-center gap-2 text-[#261CC1] mb-1">
                      <HelpCircle size={18} strokeWidth={2.5} />
                      <span className="text-sm font-black uppercase tracking-tighter italic">Excel Upload Guide</span>
                    </div>
                    <div className="space-y-3">
                      <div className="flex items-start gap-3">
                        <div className="w-5 h-5 rounded-full bg-[#1C0770] text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">1</div>
                        <p className="text-xs text-slate-600 font-bold leading-relaxed">
                          엑셀의 <span className="text-[#261CC1]">첫 번째 시트</span> 데이터를 읽어옵니다. 헤더(제목 행)가 반드시 포함되어야 합니다.
                        </p>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-5 h-5 rounded-full bg-[#1C0770] text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">2</div>
                        <div className="space-y-2">
                          <p className="text-xs text-slate-600 font-bold">다음의 <span className="text-[#3A9AFF]">정확한 컬럼명</span>을 사용해야 합니다:</p>
                          <div className="flex flex-wrap gap-1.5">
                            {['날짜', '부서', '행사명', '참석인원', '급식인원'].map(col => (
                              <span key={col} className="px-2.5 py-1 bg-white border border-slate-200 rounded-lg text-[10px] font-black text-[#1C0770] shadow-sm">{col}</span>
                            ))}
                          </div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-5 h-5 rounded-full bg-[#1C0770] text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">3</div>
                        <p className="text-xs text-slate-600 font-bold leading-relaxed">
                          날짜 형식은 <span className="bg-[#F1FF5E]/30 px-1 text-[#1C0770]">YYYY-MM-DD</span> (예: 2024-02-20)를 권장합니다.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="p-10 border-2 border-dashed border-[#3A9AFF]/20 rounded-[3rem] bg-[#f8fafc] flex flex-col items-center justify-center text-center space-y-6 group hover:border-[#3A9AFF] transition-all relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-[#F1FF5E] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div className="p-6 bg-white rounded-3xl shadow-xl text-[#3A9AFF] group-hover:scale-110 transition-transform">
                      <Upload size={40} />
                    </div>
                    <div>
                      <p className="text-sm font-black text-[#1C0770]">엑셀 파일을 드래그하여 놓거나 버튼을 누르세요</p>
                      <p className="text-[11px] text-slate-400 mt-2 font-bold flex items-center justify-center gap-1.5 uppercase">
                        <Check size={14} className="text-[#F1FF5E]" /> Only .xlsx, .xls Support
                      </p>
                    </div>
                    <input type="file" accept=".xlsx, .xls" ref={fileInputRef} onChange={handleExcelUpload} className="hidden" id="excel-upload" />
                    <label htmlFor="excel-upload" className="px-10 py-3.5 bg-[#1C0770] text-white rounded-2xl text-xs font-black cursor-pointer hover:bg-[#261CC1] transition shadow-lg active:scale-95">파일 찾아보기</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* 아카이브 리스트 */}
        {activeTab === 'list' && (
          <div className="max-w-6xl mx-auto space-y-8 animate-fadeIn">
            <div className="flex items-center justify-between">
              <h2 className="text-3xl font-black text-[#1C0770] tracking-tighter italic uppercase">Event Archive</h2>
              <div className="px-4 py-2 bg-[#261CC1]/5 text-[#261CC1] rounded-xl text-[10px] font-black border border-[#261CC1]/10">Total Records: {events.length}</div>
            </div>
            <div className="bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden">
              <table className="w-full text-left">
                <thead className="bg-[#1C0770] text-white">
                  <tr>
                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-widest text-center">Date</th>
                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-widest">Department</th>
                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-widest">Event Name</th>
                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-widest text-center">Meals</th>
                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-widest text-center">Control</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-50">
                  {events.length === 0 ? (
                    <tr><td colSpan="5" className="px-8 py-24 text-center text-slate-400 font-bold">표시할 데이터가 없습니다.</td></tr>
                  ) : (
                    [...events].reverse().map(event => (
                      <tr key={event.id} className="hover:bg-slate-50 transition group">
                        <td className="px-8 py-6 text-sm font-bold text-slate-500 text-center">{event.event_date}</td>
                        <td className="px-8 py-6"><span className="text-[10px] font-black bg-[#261CC1]/10 text-[#261CC1] px-4 py-1.5 rounded-full uppercase tracking-tighter border border-[#261CC1]/10">{event.department}</span></td>
                        <td className="px-8 py-6 text-sm font-black text-[#1C0770]">{event.event_name}</td>
                        <td className="px-8 py-6 text-center text-sm font-black text-[#3A9AFF]">{event.meal_participants}명</td>
                        <td className="px-8 py-6 text-center">
                          <button onClick={() => deleteEvent(event.id)} className="p-3 rounded-2xl transition-all text-red-400 hover:bg-red-50 hover:text-red-600 active:scale-90"><Trash2 size={20}/></button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* 관리자 설정 */}
        {activeTab === 'admin' && (
          <div className="max-w-4xl mx-auto space-y-10 animate-fadeIn">
            {!isAdmin ? (
              <div className="bg-white p-16 rounded-[4rem] shadow-2xl border border-slate-100 text-center space-y-8">
                <div className="inline-flex p-6 bg-[#1C0770]/5 rounded-full text-[#1C0770]"><Lock size={48} /></div>
                <div className="space-y-2"><h2 className="text-3xl font-black text-[#1C0770] tracking-tighter italic uppercase">Admin Access</h2><p className="text-slate-400 font-bold">관리자 암호를 입력하여 제어판을 활성화하세요.</p></div>
                <form onSubmit={handleAdminLogin} className="max-w-xs mx-auto space-y-4 pt-4">
                  <input type="password" placeholder="Password: 1416" value={pwInput} onChange={e => setPwInput(e.target.value)} className="w-full p-5 bg-[#f8fafc] border-2 border-transparent rounded-[2rem] text-center font-bold focus:border-[#3A9AFF] outline-none transition shadow-inner" />
                  <button type="submit" className="w-full bg-[#1C0770] text-white py-5 rounded-[2rem] font-black hover:bg-[#261CC1] transition shadow-2xl active:scale-95">Verify & Login</button>
                </form>
              </div>
            ) : (
              <div className="space-y-10">
                <div className="flex items-center justify-between">
                   <h2 className="text-3xl font-black text-[#1C0770] tracking-tighter italic uppercase">Settings Panel</h2>
                   <button onClick={() => { setIsAdmin(false); showMsg("로그아웃되었습니다."); }} className="px-6 py-2.5 bg-white text-red-600 rounded-2xl text-[11px] font-black hover:bg-red-50 transition uppercase tracking-widest border border-red-100 shadow-sm">Logout</button>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                  <div className="bg-white p-12 rounded-[3.5rem] shadow-sm border border-slate-100 space-y-8">
                    <div className="flex items-center space-x-3 pb-6 border-b border-slate-50"><Save size={24} className="text-[#3A9AFF]" /><h3 className="text-xl font-black text-[#1C0770]">시스템 기본값</h3></div>
                    <div className="space-y-6">
                      <div className="space-y-2"><label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">Max Capacity</label><input type="number" value={baseSettings.maxCapacity} onChange={e => setBaseSettings({...baseSettings, maxCapacity: Number(e.target.value)})} className="w-full p-5 bg-[#f8fafc] rounded-3xl font-black text-[#261CC1] border-none focus:ring-2 focus:ring-[#3A9AFF] shadow-inner" /></div>
                      <div className="space-y-2"><label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">Base Meal Count</label><input type="number" value={baseSettings.baseMealCount} onChange={e => setBaseSettings({...baseSettings, baseMealCount: Number(e.target.value)})} className="w-full p-5 bg-[#f8fafc] rounded-3xl font-black text-[#3A9AFF] border-none focus:ring-2 focus:ring-[#3A9AFF] shadow-inner" /></div>
                      <div className="space-y-2">
                        <label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">Default Operating Days</label>
                        <div className="flex gap-2">
                          {WEEKDAYS.map((day, i) => (<button key={i} onClick={() => { const newDays = [...baseSettings.operatingDays]; newDays[i] = !newDays[i]; setBaseSettings({...baseSettings, operatingDays: newDays}); }} className={`flex-1 py-4 rounded-2xl text-xs font-black transition-all ${baseSettings.operatingDays[i] ? 'bg-[#1C0770] text-white shadow-lg' : 'bg-slate-50 text-slate-400'}`}>{day}</button>))}
                        </div>
                      </div>
                      <button onClick={saveBaseSettings} disabled={loading} className="w-full bg-[#261CC1] text-white py-5 rounded-[2rem] font-black hover:bg-[#1C0770] transition-all flex items-center justify-center gap-3 shadow-xl active:scale-95">
                        {loading ? <RefreshCcw size={18} className="animate-spin" /> : <Save size={18} />}
                        <span>데이터베이스 영구 저장</span>
                      </button>
                    </div>
                  </div>
                  <div className="bg-white p-12 rounded-[3.5rem] shadow-sm border border-slate-100 space-y-6">
                    <div className="flex items-center space-x-3 pb-6 border-b border-slate-50"><CalendarIcon size={24} className="text-[#261CC1]" /><h3 className="text-xl font-black text-[#1C0770]">운영 상태 제어</h3></div>
                    <div className="p-8 bg-[#f8fafc] rounded-[2.5rem] space-y-4 border border-[#3A9AFF]/5 shadow-inner">
                      <p className="text-sm font-bold text-slate-500 leading-relaxed italic">
                        "관리자 모드가 활성화되었습니다. 이제 대시보드의 날짜 리스트를 클릭하여 즉시 특정일의 급식 운영 여부를 변경할 수 있습니다."
                      </p>
                      <div className="pt-6 flex items-center gap-2 text-[#3A9AFF] font-black text-xs uppercase tracking-widest">
                        <div className="w-2 h-2 bg-[#F1FF5E] rounded-full animate-ping"></div> Live Management Active
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </main>
    </div>
  );
}